blueprint:
  name: Controller - IKEA E2001/E2002 STYRBAR Remote control
  description: |
    # Controller - IKEA E2001/E2002 STYRBAR Remote control

    Controller automation for IKEA E2001/E2002 STYRBAR Remote control.
    Based on the [Universal Controller design](https://epmatt.github.io/awesome-ha-blueprints/docs/blueprints/controllers/starting_guide) by [EPMatt](https://epmatt.github.io/awesome-ha-blueprints/).

    ## Supported models

    - E2001
    - E2002

    ## Supported Hook

    - [Light](https://epmatt.github.io/awesome-ha-blueprints/docs/blueprints/hooks/light)
    - [Media Player](https://epmatt.github.io/awesome-ha-blueprints/docs/blueprints/hooks/media_player)
    - [Cover](https://epmatt.github.io/awesome-ha-blueprints/docs/blueprints/hooks/cover)

    ## Configuration requirements

    ### Controller Integration

    This blueprint requires your controller to be integrated with Home Assistant via:
    - [Zigbee2MQTT](https://www.zigbee2mqtt.io/) (recommended)
    - [deCONZ](https://www.home-assistant.io/integrations/deconz/)
    - [ZHA](https://www.home-assistant.io/integrations/zha/)

    In order for the blueprint to work correctly, you first need to select your controller integration in the `Integration` input.

    ### Controller Entity

    This blueprint requires the selection of a `Controller Entity`.

    If you are using Zigbe2MQTT, you need to execute a simple procedure to enable your controller entity in Home Assistant.
    Please read [this guide](https://epmatt.github.io/awesome-ha-blueprints/docs/online/zigbee2mqtt_controller_entity) for further info.

    All other integrations don't require any preliminary configuration.

    ### Last Controller Event Helper

    This blueprint requires a text helper (input_text) to store the last event triggered by the controller.
    This helper is essential for the blueprint to function correctly, as it allows to distinguish between different events (e.g. short press vs double press).
    You can create a text helper in Home Assistant via `Configuration` -> `Automations & Scenes` -> `Helpers`.
    We recommend to name the helper `Last Controller Event` followed by the name of your controller, so that you can easily identify it.
    Just select the helper in the `Last Controller Event Helper` input.

    ## Blueprint Inputs

    ### Action - Button Left Short
    Triggered when the Left button is pressed.

    ### Action - Button Left Long
    Triggered when the Left button is long pressed.

    ### Action - Button Left Release
    Triggered when the Left button is released.

    ### Action - Button Right Short
    Triggered when the Right button is pressed.

    ### Action - Button Right Double
    Triggered when the Right button is double pressed.

    ### Action - Button Right Long
    Triggered when the Right button is long pressed.

    ### Action - Button Right Release
    Triggered when the Right button is released.

    ### Action - Button Up Short
    Triggered when the Up button is pressed.

    ### Action - Button Up Double
    Triggered when the Up button is double pressed.

    ### Action - Button Up Long
    Triggered when the Up button is long pressed.

    ### Action - Button Up Release
    Triggered when the Up button is released.

    ### Action - Button Down Short
    Triggered when the Down button is pressed.

    ### Action - Button Down Double
    Triggered when the Down button is double pressed.

    ### Action - Button Down Long
    Triggered when the Down button is long pressed.

    ### Action - Button Down Release
    Triggered when the Down button is released.

  domain: automation
  input:
    integration:
      name: Integration
      description: Integration used to connect the remote with Home Assistant. Select
        one of the available options.
      selector:
        select:
          options:
          - Zigbee2MQTT
          - ZHA
          - deCONZ
    controller_entity:
      name: Controller Entity
      description: The controller entity to use.
      selector:
        entity:
          domain:
          - sensor
          - event
    helper_last_controller_event:
      name: Last Controller Event Helper
      description: Input Text used to store the last event fired by the controller.
        You will need to create a text helper (input_text) in Home Assistant.
      selector:
        entity:
          domain: input_text
    helper_double_press_delay:
      name: Double Press Delay
      description: The maximum time (in milliseconds) allowed between two button presses
        to trigger a double press event.
      default: 500
      selector:
        number:
          min: 100.0
          max: 2000.0
          unit_of_measurement: ms
          mode: box
          step: 1.0
    action_button_left_short:
      name: Action - Button Left Short
      description: Triggered when the Left button is pressed.
      default: []
      selector:
        action: {}
    action_button_left_long:
      name: Action - Button Left Long
      description: Triggered when the Left button is long pressed.
      default: []
      selector:
        action: {}
    action_button_left_release:
      name: Action - Button Left Release
      description: Triggered when the Left button is released.
      default: []
      selector:
        action: {}
    action_button_right_short:
      name: Action - Button Right Short
      description: Triggered when the Right button is pressed.
      default: []
      selector:
        action: {}
    action_button_right_double:
      name: Action - Button Right Double
      description: Triggered when the Right button is double pressed.
      default: []
      selector:
        action: {}
    action_button_right_long:
      name: Action - Button Right Long
      description: Triggered when the Right button is long pressed.
      default: []
      selector:
        action: {}
    action_button_right_release:
      name: Action - Button Right Release
      description: Triggered when the Right button is released.
      default: []
      selector:
        action: {}
    action_button_up_short:
      name: Action - Button Up Short
      description: Triggered when the Up button is pressed.
      default: []
      selector:
        action: {}
    action_button_up_double:
      name: Action - Button Up Double
      description: Triggered when the Up button is double pressed.
      default: []
      selector:
        action: {}
    action_button_up_long:
      name: Action - Button Up Long
      description: Triggered when the Up button is long pressed.
      default: []
      selector:
        action: {}
    action_button_up_release:
      name: Action - Button Up Release
      description: Triggered when the Up button is released.
      default: []
      selector:
        action: {}
    action_button_down_short:
      name: Action - Button Down Short
      description: Triggered when the Down button is pressed.
      default: []
      selector:
        action: {}
    action_button_down_double:
      name: Action - Button Down Double
      description: Triggered when the Down button is double pressed.
      default: []
      selector:
        action: {}
    action_button_down_long:
      name: Action - Button Down Long
      description: Triggered when the Down button is long pressed.
      default: []
      selector:
        action: {}
    action_button_down_release:
      name: Action - Button Down Release
      description: Triggered when the Down button is released.
      default: []
      selector:
        action: {}
    button_left_long_loop:
      name: Button Left Long - Loop
      description: Loop the action while the button is kept pressed.
      default: false
      selector:
        boolean: {}
    button_left_long_max_loop_repeats:
      name: Button Left Long - Max Loop Repeats
      description: Maximum number of loop repeats for the button long press action.
      default: 50
      selector:
        number:
          min: 1.0
          max: 1000.0
          mode: box
          step: 1.0
    button_right_long_loop:
      name: Button Right Long - Loop
      description: Loop the action while the button is kept pressed.
      default: false
      selector:
        boolean: {}
    button_right_long_max_loop_repeats:
      name: Button Right Long - Max Loop Repeats
      description: Maximum number of loop repeats for the button long press action.
      default: 50
      selector:
        number:
          min: 1.0
          max: 1000.0
          mode: box
          step: 1.0
    button_up_long_loop:
      name: Button Up Long - Loop
      description: Loop the action while the button is kept pressed.
      default: false
      selector:
        boolean: {}
    button_up_long_max_loop_repeats:
      name: Button Up Long - Max Loop Repeats
      description: Maximum number of loop repeats for the button long press action.
      default: 50
      selector:
        number:
          min: 1.0
          max: 1000.0
          mode: box
          step: 1.0
    button_down_long_loop:
      name: Button Down Long - Loop
      description: Loop the action while the button is kept pressed.
      default: false
      selector:
        boolean: {}
    button_down_long_max_loop_repeats:
      name: Button Down Long - Max Loop Repeats
      description: Maximum number of loop repeats for the button long press action.
      default: 50
      selector:
        number:
          min: 1.0
          max: 1000.0
          mode: box
          step: 1.0
  source_url: https://github.com/EPMatt/awesome-ha-blueprints/blob/main/blueprints/automation/ikea_e2001_e2002/ikea_e2001_e2002.yaml
mode: restart
max_exceeded: silent
variables:
  integration: !input integration
  controller_entity: !input controller_entity
  helper_last_controller_event: !input helper_last_controller_event
  helper_double_press_delay: !input helper_double_press_delay
  button_left_long_loop: !input button_left_long_loop
  button_left_long_max_loop_repeats: !input button_left_long_max_loop_repeats
  button_right_long_loop: !input button_right_long_loop
  button_right_long_max_loop_repeats: !input button_right_long_max_loop_repeats
  button_up_long_loop: !input button_up_long_loop
  button_up_long_max_loop_repeats: !input button_up_long_max_loop_repeats
  button_down_long_loop: !input button_down_long_loop
  button_down_long_max_loop_repeats: !input button_down_long_max_loop_repeats
  integration_id: '{{ integration | lower }}'
  trigger_delta: '{{ (as_timestamp(now()) - (states(helper_last_controller_event)
    | from_json).t) * 1000 }}'
  last_controller_event: '{{ (states(helper_last_controller_event) | from_json).a
    }}'
  adjusted_double_press_delay: '{{ helper_double_press_delay | int + 50 }}'
  integrations_with_prev_event_storage:
  - zigbee2mqtt
  - zha
  button_left_short:
  - arrow_left_click
  - left_press
  - 2002
  button_left_long:
  - arrow_left_hold
  - left_hold
  - 2001
  button_left_release:
  - arrow_left_release
  - left_release
  - 2003
  button_right_short:
  - arrow_right_click
  - right_press
  - 3002
  button_right_double:
  - arrow_right_double
  button_right_long:
  - arrow_right_hold
  - right_hold
  - 3001
  button_right_release:
  - arrow_right_release
  - right_release
  - 3003
  button_up_short:
  - on
  - up_press
  - 1002
  button_up_double:
  - on_double
  button_up_long:
  - brightness_move_up
  - up_hold
  - 1001
  button_up_release:
  - brightness_stop
  - up_release
  - 1003
  button_down_short:
  - off
  - down_press
  - 4002
  button_down_double:
  - off_double
  button_down_long:
  - brightness_move_down
  - down_hold
  - 4001
  button_down_release:
  - brightness_stop
  - down_release
  - 4003
trigger:
- platform: state
  entity_id: !input controller_entity
  attribute: action
- platform: state
  entity_id: !input controller_entity
  attribute: event
action:
- variables:
    controller_id: '{{ controller_entity }}'
    trigger_action: '{{ trigger.to_state.attributes.action if integration_id == "zigbee2mqtt"
      else trigger.to_state.attributes.event if integration_id == "deconz" else trigger.to_state.state
      }}'
- choose:
  - conditions: '{{ trigger_action | string in button_left_short }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_left_short
    - choose:
      - conditions: []
        sequence: !input action_button_left_short
  - conditions: '{{ trigger_action | string in button_left_long }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_left_long
    - choose:
      - conditions: '{{ button_left_long_loop }}'
        sequence:
        - repeat:
            while: '{{ repeat.index < button_left_long_max_loop_repeats | int }}'
            sequence: !input action_button_left_long
      default: !input action_button_left_long
  - conditions:
    - '{{ trigger_action | string in button_left_release }}'
    - '{{ not integration_id in integrations_with_prev_event_storage or last_controller_event
      | string in button_left_long }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_left_release
    - choose:
      - conditions: []
        sequence: !input action_button_left_release
  - conditions: '{{ trigger_action | string in button_right_short }}'
    sequence:
    - choose:
      - conditions: '{{ button_right_double_press }}'
        sequence:
        - choose:
          - conditions: '{{ trigger_action | string in states(helper_last_controller_event)
              and trigger_delta | int <= helper_double_press_delay | int }}'
            sequence:
            - service: input_text.set_value
              data:
                entity_id: !input helper_last_controller_event
                value: '{{ {"a":"double_press","t":as_timestamp(now())} | to_json
                  }}'
            - event: ahb_controller_event
              event_data:
                controller: '{{ controller_id }}'
                action: button_right_double
            - choose:
              - conditions: []
                sequence: !input action_button_right_double
          default:
          - delay:
              milliseconds: '{{ adjusted_double_press_delay }}'
          - event: ahb_controller_event
            event_data:
              controller: '{{ controller_id }}'
              action: button_right_short
          - choose:
            - conditions: []
              sequence: !input action_button_right_short
      default:
      - event: ahb_controller_event
        event_data:
          controller: '{{ controller_id }}'
          action: button_right_short
      - choose:
        - conditions: []
          sequence: !input action_button_right_short
  - conditions: '{{ trigger_action | string in button_right_long }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_right_long
    - choose:
      - conditions: '{{ button_right_long_loop }}'
        sequence:
        - repeat:
            while: '{{ repeat.index < button_right_long_max_loop_repeats | int }}'
            sequence: !input action_button_right_long
      default: !input action_button_right_long
  - conditions:
    - '{{ trigger_action | string in button_right_release }}'
    - '{{ not integration_id in integrations_with_prev_event_storage or last_controller_event
      | string in button_right_long }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_right_release
    - choose:
      - conditions: []
        sequence: !input action_button_right_release
  - conditions: '{{ trigger_action | string in button_up_short }}'
    sequence:
    - choose:
      - conditions: '{{ button_up_double_press }}'
        sequence:
        - choose:
          - conditions: '{{ trigger_action | string in states(helper_last_controller_event)
              and trigger_delta | int <= helper_double_press_delay | int }}'
            sequence:
            - service: input_text.set_value
              data:
                entity_id: !input helper_last_controller_event
                value: '{{ {"a":"double_press","t":as_timestamp(now())} | to_json
                  }}'
            - event: ahb_controller_event
              event_data:
                controller: '{{ controller_id }}'
                action: button_up_double
            - choose:
              - conditions: []
                sequence: !input action_button_up_double
          default:
          - delay:
              milliseconds: '{{ adjusted_double_press_delay }}'
          - event: ahb_controller_event
            event_data:
              controller: '{{ controller_id }}'
              action: button_up_short
          - choose:
            - conditions: []
              sequence: !input action_button_up_short
      default:
      - event: ahb_controller_event
        event_data:
          controller: '{{ controller_id }}'
          action: button_up_short
      - choose:
        - conditions: []
          sequence: !input action_button_up_short
  - conditions: '{{ trigger_action | string in button_up_long }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_up_long
    - choose:
      - conditions: '{{ button_up_long_loop }}'
        sequence:
        - repeat:
            while: '{{ repeat.index < button_up_long_max_loop_repeats | int }}'
            sequence: !input action_button_up_long
      default: !input action_button_up_long
  - conditions:
    - '{{ trigger_action | string in button_up_release }}'
    - '{{ not integration_id in integrations_with_prev_event_storage or last_controller_event
      | string in button_up_long }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_up_release
    - choose:
      - conditions: []
        sequence: !input action_button_up_release
  - conditions: '{{ trigger_action | string in button_down_short }}'
    sequence:
    - choose:
      - conditions: '{{ button_down_double_press }}'
        sequence:
        - choose:
          - conditions: '{{ trigger_action | string in states(helper_last_controller_event)
              and trigger_delta | int <= helper_double_press_delay | int }}'
            sequence:
            - service: input_text.set_value
              data:
                entity_id: !input helper_last_controller_event
                value: '{{ {"a":"double_press","t":as_timestamp(now())} | to_json
                  }}'
            - event: ahb_controller_event
              event_data:
                controller: '{{ controller_id }}'
                action: button_down_double
            - choose:
              - conditions: []
                sequence: !input action_button_down_double
          default:
          - delay:
              milliseconds: '{{ adjusted_double_press_delay }}'
          - event: ahb_controller_event
            event_data:
              controller: '{{ controller_id }}'
              action: button_down_short
          - choose:
            - conditions: []
              sequence: !input action_button_down_short
      default:
      - event: ahb_controller_event
        event_data:
          controller: '{{ controller_id }}'
          action: button_down_short
      - choose:
        - conditions: []
          sequence: !input action_button_down_short
  - conditions: '{{ trigger_action | string in button_down_long }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_down_long
    - choose:
      - conditions: '{{ button_down_long_loop }}'
        sequence:
        - repeat:
            while: '{{ repeat.index < button_down_long_max_loop_repeats | int }}'
            sequence: !input action_button_down_long
      default: !input action_button_down_long
  - conditions:
    - '{{ trigger_action | string in button_down_release }}'
    - '{{ not integration_id in integrations_with_prev_event_storage or last_controller_event
      | string in button_down_long }}'
    sequence:
    - event: ahb_controller_event
      event_data:
        controller: '{{ controller_id }}'
        action: button_down_release
    - choose:
      - conditions: []
        sequence: !input action_button_down_release
